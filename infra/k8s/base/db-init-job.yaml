apiVersion: batch/v1
kind: Job
metadata:
  name: db-init-job
spec:
  template:
    spec:
      containers:
      - name: db-init
        image: mcr.microsoft.com/mssql/server:2022-latest
        command: ["/bin/bash", "-c"]
        args:
        - |
          # Determine the sqlcmd path
          if [ -f /opt/mssql-tools18/bin/sqlcmd ]; then
            SQLCMD="/opt/mssql-tools18/bin/sqlcmd"
          elif [ -f /opt/mssql-tools/bin/sqlcmd ]; then
            SQLCMD="/opt/mssql-tools/bin/sqlcmd"
          else
            echo "sqlcmd not found"
            exit 1
          fi

          echo "Waiting for SQL Server to be ready..."
          until $SQLCMD -S sql-service -U sa -P "$MSSQL_SA_PASSWORD" -Q "SELECT 1" -C &> /dev/null; do
            echo "SQL Server is unavailable - sleeping"
            sleep 5
          done
          echo "SQL Server is up - executing initialization script"
          $SQLCMD -S sql-service -U sa -P "$MSSQL_SA_PASSWORD" -Q "IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = 'AgroSolutionsAnalise') CREATE DATABASE AgroSolutionsAnalise; IF NOT EXISTS (SELECT name FROM sys.databases WHERE name = 'AgroSolutionsPropriedades') CREATE DATABASE AgroSolutionsPropriedades;" -C
        env:
        - name: MSSQL_SA_PASSWORD
          valueFrom:
            secretKeyRef:
              name: sql-server-secret
              key: MSSQL_SA_PASSWORD
      restartPolicy: OnFailure
